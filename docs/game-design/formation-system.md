# 전술 포메이션 시스템

> [← 기획 총괄로 돌아가기](./overview.md)

---

## 개요

포메이션은 [미니언](./minion-system.md)의 배치 패턴을 결정하는 시스템이다. 기존 Survivors 게임의 자동 발사체와 달리, 미니언의 물리적 위치가 전투 결과에 직접 영향을 준다. 3가지 포메이션을 상황에 맞게 전환하는 것이 생존의 핵심이다.

---

## 포메이션 목록

### 1. Defensive Phalanx (방어 진형)

네크로맨서 전방에 미니언을 밀집 배치하여 방패벽을 형성한다.

```
       이동 방향 →

    M M M M M        M = 미니언
    M M M M M        P = 네크로맨서(플레이어)
      M M M
        P
```

| 항목        | 값                                         |
| ----------- | ------------------------------------------ |
| 보너스      | 미니언 방어력 +30%, 미니언 넉백 저항       |
| 패널티      | 미니언 공격속도 -20%, 미니언 이동속도 -10% |
| 적합 상황   | 전방에서 밀려오는 대규모 웨이브            |
| 미니언 행동 | Guard 모드 우선 (포메이션 위치 고수)       |

### 2. Aggressive Charge (공격 진형)

미니언을 네크로맨서 전방 넓은 범위에 쐐기형으로 전개한다.

```
       이동 방향 →

            M
          M M
        M M M
      M M M
    P   M M
      M M M
        M M M
          M M
            M
```

| 항목        | 값                                       |
| ----------- | ---------------------------------------- |
| 보너스      | 미니언 공격력 +25%, 미니언 이동속도 +15% |
| 패널티      | 미니언 HP -15%, 네크로맨서 후방 노출     |
| 적합 상황   | 한 방향으로 돌파, 소수 강적 상대         |
| 미니언 행동 | Attack 모드 우선 (적극적 추적)           |

### 3. Circular Guard (원형 진형)

네크로맨서를 중심으로 미니언을 원형 배치한다.

```
        M M M
      M       M
    M           M
    M     P     M
    M           M
      M       M
        M M M
```

| 항목        | 값                                                 |
| ----------- | -------------------------------------------------- |
| 보너스      | 네크로맨서 피격 확률 대폭 감소, 전방위 방어        |
| 패널티      | 미니언 공격력 -10%, 미니언 분산으로 화력 집중 불가 |
| 적합 상황   | 사방에서 적이 접근하는 상황, 보스전 초반           |
| 미니언 행동 | Follow + Attack 혼합 (원형 유지하며 접근 적 공격)  |

---

## 포메이션 전환

### 전환 규칙

| 항목      | 값                                        |
| --------- | ----------------------------------------- |
| 입력      | Q 키                                      |
| 전환 순서 | Phalanx → Charge → Circular → Phalanx ... |
| 전환 시간 | 1.0초 (미니언이 새 위치로 이동하는 시간)  |
| 쿨타임    | 3.0초                                     |

### 전환 중 동작

- 전환이 시작되면 미니언은 새 포메이션 위치로 이동을 시작
- 전환 중에는 **기존 보너스/패널티가 모두 해제** (무보너스 상태)
- 새 위치에 도달하면 새 포메이션의 보너스/패널티 적용
- 전환 중 공격은 가능하지만, 이동 중이므로 DPS가 자연 감소

---

## Flocking AI 동작 원리

미니언의 이동은 Boids 알고리즘의 경량 변형을 사용한다.

### 3대 규칙

```
1. Separation (분리)
   다른 미니언과 너무 가까우면 밀어냄 → 겹침 방지

   M ←→ M    (서로 반발)

2. Alignment (정렬)
   주변 미니언의 이동 방향에 맞춤 → 무리 이동

   M → M → M →    (같은 방향)

3. Cohesion (결속)
   무리의 중심으로 이동 → 흩어짐 방지

        M
       ↙
   M → ● ← M    (●= 무리 중심)
       ↗
        M
```

### 포메이션과의 결합

- 각 미니언에게 **목표 위치** (포메이션 슬롯)가 할당됨
- Flocking 규칙에 **포메이션 위치로의 인력**이 추가됨
- 결과적으로 미니언은 자연스럽게 군집 이동하면서도 포메이션 형태를 유지

### 가중치 (기본값)

| 규칙             | 가중치 | 비고                      |
| ---------------- | ------ | ------------------------- |
| Separation       | 1.5    | 겹침 방지 최우선          |
| Alignment        | 0.5    | 부드러운 무리 이동        |
| Cohesion         | 0.8    | 흩어짐 방지               |
| Formation Target | 2.0    | 포메이션 유지가 가장 강력 |
| Enemy Avoidance  | 0.3    | Follow 모드에서만 적용    |

### 성능 최적화

- 매 프레임이 아닌 **0.2초 간격**으로 Flocking 계산 (성능 절감)
- 인접 미니언 탐색에 **Spatial Hashing** 사용
- 미니언 수가 50 초과 시 Alignment 규칙 **비활성화** (성능 확보)
- Object Pooling으로 미니언 생성/삭제 비용 최소화
