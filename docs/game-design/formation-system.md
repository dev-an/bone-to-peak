# 전술 포메이션 시스템

> [← 기획 총괄로 돌아가기](./overview.md)

---

## 개요

포메이션은 [미니언](./minion-system.md)의 배치 패턴을 결정하는 시스템이다. 기존 Survivors 게임의 자동 발사체와 달리, 미니언의 물리적 위치가 전투 결과에 직접 영향을 준다. 3가지 포메이션을 상황에 맞게 전환하는 것이 생존의 핵심이다.

---

## 포메이션 목록

### 1. Defensive Phalanx (방어 진형)

네크로맨서 전방에 미니언을 밀집 배치하여 방패벽을 형성한다.

```
       이동 방향 →

    M M M M M        M = 미니언
    M M M M M        P = 네크로맨서(플레이어)
      M M M
        P
```

| 항목        | 값                                         |
| ----------- | ------------------------------------------ |
| 보너스      | 미니언 방어력 +30%, 미니언 넉백 저항       |
| 패널티      | 미니언 공격속도 -20%, 미니언 이동속도 -10% |
| 적합 상황   | 전방에서 밀려오는 대규모 웨이브            |
| 미니언 행동 | Guard 모드 우선 (포메이션 위치 고수)       |

### 2. Aggressive Charge (공격 진형)

미니언을 네크로맨서 전방 넓은 범위에 쐐기형으로 전개한다.

```
       이동 방향 →

            M
          M M
        M M M
      M M M
    P   M M
      M M M
        M M M
          M M
            M
```

| 항목        | 값                                       |
| ----------- | ---------------------------------------- |
| 보너스      | 미니언 공격력 +25%, 미니언 이동속도 +15% |
| 패널티      | 미니언 HP -15%, 네크로맨서 후방 노출     |
| 적합 상황   | 한 방향으로 돌파, 소수 강적 상대         |
| 미니언 행동 | Attack 모드 우선 (적극적 추적)           |

### 3. Circular Guard (원형 진형)

네크로맨서를 중심으로 미니언을 원형 배치한다.

```
        M M M
      M       M
    M           M
    M     P     M
    M           M
      M       M
        M M M
```

| 항목        | 값                                                 |
| ----------- | -------------------------------------------------- |
| 보너스      | 네크로맨서 피격 확률 대폭 감소, 전방위 방어        |
| 패널티      | 미니언 공격력 -10%, 미니언 분산으로 화력 집중 불가 |
| 적합 상황   | 사방에서 적이 접근하는 상황, 보스전 초반           |
| 미니언 행동 | Follow + Attack 혼합 (원형 유지하며 접근 적 공격)  |

---

## 포메이션 전환

### 전환 규칙

| 항목      | 값                                        |
| --------- | ----------------------------------------- |
| 입력      | Q 키                                      |
| 전환 순서 | Phalanx → Charge → Circular → Phalanx ... |
| 전환 시간 | 1.0초 (미니언이 새 위치로 이동하는 시간)  |
| 쿨타임    | 3.0초                                     |

### 전환 중 동작

- 전환이 시작되면 미니언은 새 포메이션 위치로 이동을 시작
- 전환 중에는 **기존 보너스/패널티가 모두 해제** (무보너스 상태)
- 새 위치에 도달하면 새 포메이션의 보너스/패널티 적용
- 전환 중 공격은 가능하지만, 이동 중이므로 DPS가 자연 감소
- 전환 중 Guard 상태 미니언은 즉시 Follow로 전환

### 전환 시 보너스/패널티 타이밍

```
T=0.0s: Q 키 입력 → 기존 보너스/패널티 즉시 해제
T=0.0~1.0s: 미니언이 새 위치로 이동 (무보너스 상태)
T=1.0s: 새 포메이션 슬롯 도달 → 새 보너스/패널티 적용
T=3.0s: 전환 쿨타임 종료, 다시 전환 가능
```

> 보너스/패널티는 점진적이 아닌 **즉시 전환** 방식이다. 1초 전환 시간은 물리적 이동에만 해당한다.

---

## Flocking AI 동작 원리

미니언의 이동은 Boids 알고리즘의 경량 변형을 사용한다.

### 3대 규칙

```
1. Separation (분리)
   다른 미니언과 너무 가까우면 밀어냄 → 겹침 방지

   M ←→ M    (서로 반발)

2. Alignment (정렬)
   주변 미니언의 이동 방향에 맞춤 → 무리 이동

   M → M → M →    (같은 방향)

3. Cohesion (결속)
   무리의 중심으로 이동 → 흩어짐 방지

        M
       ↙
   M → ● ← M    (●= 무리 중심)
       ↗
        M
```

### 포메이션과의 결합

- 각 미니언에게 **목표 위치** (포메이션 슬롯)가 할당됨
- Flocking 규칙에 **포메이션 위치로의 인력**이 추가됨
- 결과적으로 미니언은 자연스럽게 군집 이동하면서도 포메이션 형태를 유지

---

## 미니언 배치 우선순위

포메이션 슬롯에 미니언을 배정할 때, 미니언의 **역할(전위/중위/후위)**에 따라 자동으로 적절한 위치에 배치된다. 상세 분류는 [미니언 시스템 → 포메이션 배치 우선순위](./minion-system.md)를 참고한다.

### 배치 순서

```
슬롯 배정 순서:
1. 전위 (탱커): 좀비, 그래브 나이트, 본 골렘, 데스 나이트
   → 포메이션의 전방/외곽 슬롯에 배치
2. 중위 (근접 딜러): 스켈레톤 워리어
   → 중간 슬롯에 배치
3. 후위 (원거리): 스켈레톤 아처, 레이스, 본 드래곤, 리치
   → 후방/내곽 슬롯에 배치
```

### 포메이션별 배치 해석

| 포메이션          | 전위 위치              | 후위 위치             |
| ----------------- | ---------------------- | --------------------- |
| Defensive Phalanx | 가장 앞 행 (적과 접촉) | 가장 뒤 행 (안전)     |
| Aggressive Charge | 쐐기 선두 (돌격 선봉)  | 쐐기 후미 (후방 지원) |
| Circular Guard    | 적 접근 방향 쪽        | 적 반대쪽 (네크로 뒤) |

---

## 포메이션 슬롯 좌표 계산

### 공통 개념

- 모든 좌표는 **네크로맨서 기준 상대 좌표**로 계산 (네크로맨서 위치 = 원점)
- **전방(Forward)**: 아래 우선순위에 따라 결정
    1. 이동 중: 현재 이동 방향
    2. 정지 + 마우스 이동 중: 마우스 커서 방향 (네크로맨서→커서 벡터)
    3. 정지 + 마우스 고정: 마지막 이동 방향 유지 (기본값: 오른쪽)
    4. 전방 전환 시 포메이션이 **0.3초에 걸쳐 부드럽게 회전** (즉시 스냅 아님)
- 슬롯 번호는 0부터 시작, 역할 기반 우선순위에 따라 할당 (전위→중위→후위)
- T3 미니언(슬롯 2개)은 첫 번째 슬롯 위치만 사용, 나머지 1개는 빈 슬롯으로 예약

### 1. Defensive Phalanx 슬롯 계산

전방에 직사각형 격자 형태로 배치. 행 수가 줄어드는 사다리꼴 구조.

```
슬롯 배치 공식:
- 열 간격: 1.2 유닛
- 행 간격: 1.0 유닛
- 행당 슬롯 수: [5, 5, 3, 2] (최대 15슬롯)
- 기준점: 네크로맨서 전방 2.0 유닛

slot_offset(index):
  행(row) = index가 속한 행 번호 (0부터)
  열(col) = 해당 행 내 인덱스
  행내_총수 = [5, 5, 3, 2][row]

  x = (col - (행내_총수 - 1) / 2.0) × 1.2    // 좌우 중심 정렬
  y = (row + 1) × 1.0                          // 전방으로 오프셋

  // 전방 방향으로 회전 적용
  rotated = rotate(x, y, forward_angle)
  result = player_pos + rotated
```

### 2. Aggressive Charge 슬롯 계산

전방 쐐기(V자) 형태. 미니언 인덱스가 커질수록 외곽으로 배치.

```
슬롯 배치 공식:
- 행 간격: 1.5 유닛 (전방 방향)
- 좌우 확장 각도: 행당 ±30도 확장
- 기준점: 네크로맨서 전방 1.5 유닛

slot_offset(index):
  // 홀수 인덱스는 좌측, 짝수 인덱스는 우측 (0번은 선두)
  if index == 0:
    x = 0, y = 3.0                             // 선두 (가장 전방)
  else:
    side = (index % 2 == 1) ? -1 : 1           // 좌(-1) / 우(+1)
    depth = ceil(index / 2)                     // 행 번호 (1부터)
    x = side × depth × 1.2                     // 좌우 확장
    y = 3.0 - depth × 0.8                      // 행이 깊을수록 후방

  rotated = rotate(x, y, forward_angle)
  result = player_pos + rotated
```

### 3. Circular Guard 슬롯 계산

네크로맨서 중심 원형 배치. 현재 소환된 미니언 수에 따라 원의 반지름과 간격이 동적 조정.

```
슬롯 배치 공식:
- 기본 반지름: 2.5 유닛
- 최대 반지름: 4.0 유닛 (미니언 10마리 초과 시)
- 미니언 간 최소 각도 간격: 360 / max_slots

slot_offset(index, total_minions):
  radius = min(2.5 + total_minions × 0.15, 4.0)
  angle = (360.0 / total_minions) × index      // 균등 분배
  angle_offset = forward_angle                  // 0번 슬롯이 전방

  x = cos(angle + angle_offset) × radius
  y = sin(angle + angle_offset) × radius

  result = player_pos + (x, y)
```

### 슬롯 재배정 규칙

- 미니언 사망/소환 시 슬롯 번호 **재배정** (빈 슬롯 압축)
- 재배정 시 미니언은 기존 슬롯 → 새 슬롯으로 부드럽게 이동 (Flocking으로 자연 이동)
- 재배정 빈도: 미니언 수 변화 시 **즉시** 재계산 (0.1초 딜레이로 연속 변화 배치)

### 가중치 (기본값)

| 규칙             | 가중치 | 비고                      |
| ---------------- | ------ | ------------------------- |
| Separation       | 1.5    | 겹침 방지 최우선          |
| Alignment        | 0.5    | 부드러운 무리 이동        |
| Cohesion         | 0.8    | 흩어짐 방지               |
| Formation Target | 2.0    | 포메이션 유지가 가장 강력 |
| Enemy Avoidance  | 0.3    | Follow 모드에서만 적용    |

### 성능 최적화

- 매 프레임이 아닌 **0.2초 간격**으로 Flocking 계산 (성능 절감)
    - 0.2초는 FixedUpdate 기반이 아닌 **코루틴/타이머 기반** (프레임률 독립적)
    - 각 미니언의 Flocking 타이머에 **랜덤 오프셋** 추가 (0~0.1초)하여 프레임 분산
- 인접 미니언 탐색에 **Spatial Hashing** 사용
    - 그리드 셀 크기: **3.0 × 3.0 유닛** (Separation 반경 1.5의 2배)
    - 탐색 범위: 현재 셀 + 인접 8셀 (총 9셀)
    - 그리드는 매 Flocking 계산 주기(0.2초)마다 갱신
- 미니언 수가 50 초과 시 Alignment 규칙 **완전 비활성화** (가중치 0으로 설정)
- Object Pooling으로 미니언 생성/삭제 비용 최소화
