# 레벨 & 맵 디자인

> [← 기획 총괄로 돌아가기](./overview.md)

---

## 개요

Bone-To-Peak의 맵은 네크로맨서와 언데드 군단이 활동하는 전장이다. Survivors-like 장르의 관례에 따라 넓은 필드에서 자유롭게 이동하되, **지형 요소**가 포메이션 운용과 시체 수집에 전술적 깊이를 더한다.

### 설계 원칙

1. **포메이션 우선**: 3가지 [포메이션](./formation-system.md)이 효과적으로 작동할 수 있는 충분한 열린 공간 보장
2. **전술적 지형**: 장애물로 적의 접근 경로를 유도하고, 플레이어가 지형을 활용한 전략 수립 가능
3. **자원 접근성**: [Corpse](./corpse-economy.md) 수집 동선이 자연스러워야 하며, 장애물이 수집을 지나치게 방해하지 않음
4. **시각적 가독성**: 적, 미니언, Corpse, 장애물이 2D 탑뷰에서 명확히 구분됨

---

## 맵 구조

### 맵 크기

| 항목 | 값 | 비고 |
| --- | --- | --- |
| 맵 전체 크기 | 80 × 80 유닛 | 정사각형 |
| 카메라 표시 영역 | 20 × 12 유닛 (16:9 기준) | Cinemachine Follow |
| 플레이어 활동 영역 | 76 × 76 유닛 | 맵 경계에서 2 유닛 안쪽 |
| 적 스폰 영역 | 카메라 밖 1~2 유닛 | 화면 밖 전방위 |

### 맵 경계

```
┌─────────────────────────────────────┐
│  ░░░░░░░ 죽음의 안개 (경계) ░░░░░░░  │
│  ░ ┌─────────────────────────────┐ ░  │
│  ░ │                             │ ░  │
│  ░ │       플레이어 활동 영역      │ ░  │
│  ░ │                             │ ░  │
│  ░ │         [카메라 뷰]          │ ░  │
│  ░ │        ┌──────────┐         │ ░  │
│  ░ │        │     P    │         │ ░  │
│  ░ │        └──────────┘         │ ░  │
│  ░ │                             │ ░  │
│  ░ └─────────────────────────────┘ ░  │
│  ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░  │
└─────────────────────────────────────┘
```

- **죽음의 안개**: 맵 경계 2 유닛 폭의 안개 영역. 시각적 경고 역할
- 안개에 진입하면 초당 5 피해 (네크로맨서, 미니언 모두)
- 적은 안개를 통과하여 스폰되지만, 안개 피해는 받지 않음
- 안개 경계에 도달하면 화면 가장자리에 방향 화살표 표시

---

## 바이옴 (맵 테마)

런 시작 시 하나의 바이옴이 선택된다. 바이옴은 **시각적 차이**와 **고유 지형 요소**를 제공하지만, 핵심 게임플레이 밸런스에는 영향을 주지 않는다.

### 1. 버려진 묘지 (Forsaken Graveyard)

> 기본 바이옴. 첫 플레이부터 해금.

| 항목 | 설명 |
| --- | --- |
| 분위기 | 달빛 아래 무너진 묘비와 철책, 푸른 안개 |
| 바닥 타일 | 흙길, 잔디, 깨진 석판 |
| 고유 장애물 | 묘비석 (소형), 석관 (중형), 무너진 석상 (대형) |
| 고유 요소 | 묘지 토양 — Corpse 바닥 유지 시간 +1초 (6초) |
| 색조 | 짙은 남색 + 연한 녹색 하이라이트 |

### 2. 전쟁터 폐허 (Ruined Battlefield)

> 메타 진행 해금: 누적 킬 500회.

| 항목 | 설명 |
| --- | --- |
| 분위기 | 잿빛 평야에 꽂힌 깃발과 부서진 무기, 연기 |
| 바닥 타일 | 진흙, 마른 풀, 핏자국 |
| 고유 장애물 | 부서진 전차 (대형), 방패 잔해 (소형), 참호 (선형) |
| 고유 요소 | 산화된 무기 — 엘리트 적 스폰 확률 +5% (기본 10% → 15%) |
| 색조 | 잿빛 + 짙은 적색 포인트 |

### 3. 지하 묘소 (Crypt Depths)

> 메타 진행 해금: 웨이브 15 클리어.

| 항목 | 설명 |
| --- | --- |
| 분위기 | 어두운 지하 공간, 촛불과 마법진, 뼈 기둥 |
| 바닥 타일 | 석재 바닥, 금이 간 타일, 마법 문양 |
| 고유 장애물 | 석관 기둥 (소형), 제단 (중형), 뼈 벽 (대형/선형) |
| 고유 요소 | 네크로 공명 — Raise 쿨타임 -0.3초 |
| 색조 | 짙은 보라 + 녹색 마법 발광 |

---

## 장애물 시스템

### 장애물 분류

장애물은 크기와 상호작용 방식에 따라 3종류로 나뉜다.

#### 소형 장애물

```
  ▓▓
  ▓▓     1×1 유닛
```

| 항목 | 값 |
| --- | --- |
| 크기 | 1 × 1 유닛 |
| 충돌 | 이동 불가 (슬라이딩 처리) |
| 투사체 | 차단 (영혼 화살, 적 원거리 공격 모두) |
| 파괴 가능 | 아니오 |
| Corpse 상호작용 | Corpse가 위에 떨어질 수 있음 (수집 가능) |
| 맵당 배치 수 | 20~30개 |

#### 중형 장애물

```
  ▓▓▓▓
  ▓▓▓▓    2×2 유닛
```

| 항목 | 값 |
| --- | --- |
| 크기 | 2 × 2 유닛 |
| 충돌 | 이동 불가 (슬라이딩 처리) |
| 투사체 | 차단 |
| 파괴 가능 | 예 — HP 100, 파괴 시 Corpse 1개 드롭 |
| Corpse 상호작용 | Corpse가 위에 떨어질 수 있음 (수집 가능) |
| 맵당 배치 수 | 8~12개 |

#### 대형 장애물

```
  ▓▓▓▓▓▓▓▓
  ▓▓▓▓▓▓▓▓    4×2 유닛 (또는 선형)
```

| 항목 | 값 |
| --- | --- |
| 크기 | 4 × 2 유닛 (또는 1 × 6 선형) |
| 충돌 | 이동 불가 (슬라이딩 처리) |
| 투사체 | 차단 |
| 파괴 가능 | 아니오 |
| Corpse 상호작용 | Corpse가 장애물 뒤로 밀려남 (장애물 위 적재 불가) |
| 맵당 배치 수 | 3~5개 |

### 장애물 배치 규칙

```
맵 생성 시 장애물 배치 알고리즘:

1. 맵 중심 8×8 유닛 = 안전 구역 (장애물 없음)
   → 플레이어 시작 위치 주변 여유 보장

2. 안전 구역 바깥에 장애물 랜덤 배치
   → 장애물 간 최소 간격: 3 유닛 (포메이션 이동 보장)
   → 장애물 총 면적 ≤ 맵 활동 영역의 8% (약 460 제곱 유닛)

3. 맵 가장자리 5 유닛 이내에는 대형 장애물 배치 금지
   → 적 스폰 경로 차단 방지

4. 경로 유효성 검증
   → BFS/Flood Fill로 맵 전체 이동 가능 확인
   → 막다른 길이 생기지 않도록 검증
```

### 장애물과 시스템 상호작용

| 시스템 | 상호작용 |
| --- | --- |
| [포메이션](./formation-system.md) | 미니언이 장애물 주변을 우회하여 포메이션 슬롯으로 이동. 장애물로 인해 대형 포메이션이 분리될 수 있음 |
| [Flocking AI](./formation-system.md) | Obstacle Avoidance 가중치 추가 (가중치 1.8). 장애물 감지 범위 2.0 유닛 |
| [Corpse 수집](./corpse-economy.md) | 소형/중형 장애물 위의 Corpse는 정상 수집. 대형 장애물 뒤의 Corpse는 우회 필요 |
| [Explode](./corpse-economy.md) | 폭발은 장애물을 관통 (장애물 뒤 적에게도 피해). 중형 장애물은 Explode로 파괴 가능 |
| 적 AI | 적은 장애물을 우회하여 네크로맨서에게 접근. A* 또는 Steering 기반 회피 |
| 보스 | 보스는 장애물 파괴 가능 (접촉 시 즉시 파괴). 보스전에서 지형 변화 발생 |

---

## 적 스폰 영역

### 스폰 위치 상세

[적 & 웨이브 시스템](./enemy-wave-system.md)에서 정의된 스폰 규칙의 공간적 상세.

```
                    스폰 영역 (카메라 밖 1~2 유닛)
            ┌─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─┐
            ╎  ┌───────────────────────────┐  ╎
            ╎  │                           │  ╎
            ╎  │      카메라 영역          │  ╎
            ╎  │                           │  ╎
            ╎  │           P               │  ╎
            ╎  │                           │  ╎
            ╎  └───────────────────────────┘  ╎
            └─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─┘
```

### 스폰 방향 가중치

적이 스폰되는 방향은 완전 랜덤이 아니라, 플레이어 이동 방향에 따라 가중치가 적용된다.

| 방향 | 가중치 | 설명 |
| --- | --- | --- |
| 플레이어 이동 전방 | 40% | 앞에서 적이 많이 나와 전방 돌파 판단 유도 |
| 플레이어 이동 측면 | 각 20% | 포위 압박 |
| 플레이어 이동 후방 | 20% | 후퇴 방해 |

- 플레이어가 정지 상태면 전방위 균등 분배 (각 25%)
- 보스는 항상 화면 상단에서 등장 (고정)

### 스폰 금지 구역

| 구역 | 반경 | 사유 |
| --- | --- | --- |
| 네크로맨서 근접 | 8 유닛 | 갑작스러운 출현 방지 |
| 대형 장애물 뒤 | 3 유닛 | 막힌 경로에서 스폰 방지 |
| 맵 경계 안개 내부 | 2 유닛 (경계 두께) | 경계에 의미 없이 갇히는 적 방지 |

---

## 특수 지형 요소

### 1. 네크로 원천 (Necro Font)

맵에 1~2개 존재하는 마법 원천. 위에 서 있으면 버프를 받는다.

```
      ·  ·  ·
    ·  ╔════╗  ·
    · ║ ◆◆ ║ ·        2×2 유닛
    ·  ╚════╝  ·
      ·  ·  ·
```

| 항목 | 값 |
| --- | --- |
| 크기 | 2 × 2 유닛 |
| 효과 | 위에 서 있는 동안 Corpse 수집 범위 +2.0 유닛 |
| 충돌 | 없음 (통과 가능) |
| 시각 표현 | 바닥에 녹색 마법진, 지속적으로 미세하게 발광 |
| 맵당 배치 수 | 1~2개 |
| 배치 조건 | 맵 중심에서 15~30 유닛 거리 |

### 2. 오염된 웅덩이 (Blight Pool)

맵에 2~3개 존재하는 위험 지형.

```
      ~~~
    ~~~~~~~
    ~~~~~~~         3×3 유닛 (불규칙 형태)
      ~~~
```

| 항목 | 값 |
| --- | --- |
| 크기 | 3 × 3 유닛 (불규칙 원형) |
| 효과 | 진입한 유닛에게 초당 3 피해 (아군/적군 모두) |
| 충돌 | 없음 (통과 가능, 감속 30%) |
| Corpse 상호작용 | 웅덩이 안에서 사망한 적은 Corpse가 오염됨 → 수집 시 1.5배 가치 |
| 시각 표현 | 보라색/독색 액체, 기포 파티클 |
| 맵당 배치 수 | 2~3개 |
| 배치 조건 | 맵 중심에서 20~35 유닛 거리 |

### 3. 뼈 제단 (Bone Altar)

맵에 1개 존재하는 이벤트 지형. 웨이브 10 이후 활성화된다.

| 항목 | 값 |
| --- | --- |
| 크기 | 3 × 3 유닛 |
| 활성화 조건 | 웨이브 10 도달 시 제단에 불이 켜짐 |
| 효과 | Corpse 15개를 제단에 바침 → 랜덤 T2 미니언 1마리 즉시 소환 (슬롯 무관, 추가 소환) |
| 재사용 | 일회성 (런당 1회) |
| 시각 표현 | 뼈로 만든 제단, 비활성 시 회색, 활성 시 붉은 불꽃 |
| 배치 조건 | 맵 중심에서 25~35 유닛 거리 |

---

## 맵 생성 (절차적 배치)

맵의 전체 크기와 경계는 고정이지만, 장애물과 특수 지형의 배치는 런마다 다르다.

### 생성 순서

```
1. 고정 레이어 생성
   └── 맵 경계(죽음의 안개) 배치
   └── 바이옴 바닥 타일 채우기

2. 특수 지형 배치 (우선)
   └── 네크로 원천 1~2개 (최소 거리 20 유닛 이격)
   └── 오염된 웅덩이 2~3개 (최소 거리 10 유닛 이격)
   └── 뼈 제단 1개

3. 대형 장애물 배치
   └── 3~5개, 특수 지형과 5 유닛 이상 이격
   └── 서로 8 유닛 이상 이격

4. 중형 장애물 배치
   └── 8~12개, 기존 배치물과 3 유닛 이상 이격

5. 소형 장애물 배치
   └── 20~30개, 기존 배치물과 2 유닛 이상 이격

6. 경로 유효성 검증
   └── Flood Fill: 맵 전체 접근 가능 확인
   └── 실패 시 마지막 배치 장애물 제거 후 재시도

7. 시작 지점 설정
   └── 맵 중심 = 네크로맨서 시작 위치
```

### 시드 기반 생성

- 맵 생성에 **시드(Seed)** 사용 → 같은 시드 = 같은 맵
- 런 결과 화면에서 시드 번호 표시 (공유 가능)
- 메타 진행과 시드는 독립적

---

## 카메라 시스템

### 기본 동작

| 항목 | 값 |
| --- | --- |
| 구현 | Cinemachine 3.x Follow |
| 추적 대상 | 네크로맨서 |
| 추적 댐핑 | X: 0.3, Y: 0.3 (부드러운 추적) |
| 데드존 | 화면 중심 20% 영역 (미세 이동 시 카메라 고정) |
| 소프트존 | 화면 중심 60% 영역 |

### Look-Ahead (선행 시점)

플레이어 이동 방향으로 카메라가 약간 앞서 이동하여 전방 시야를 확보한다.

| 항목 | 값 |
| --- | --- |
| 선행 거리 | 이동 방향으로 2.0 유닛 |
| 선행 속도 | 0.5초에 걸쳐 부드럽게 전환 |
| 정지 시 복귀 | 1.0초에 걸쳐 중심으로 복귀 |

### 카메라 경계

- 카메라는 맵 경계 밖을 비추지 않음 (Cinemachine Confiner 2D 사용)
- 맵 가장자리에 도달하면 카메라가 멈추고, 플레이어만 이동

### 보스전 카메라

- 보스 등장 시 카메라가 **1.5초에 걸쳐 살짝 줌아웃** (Scale ×0.85)
- 보스와 네크로맨서를 동시에 화면에 담기 위한 조치
- 보스 처치 후 1.0초에 걸쳐 원래 줌으로 복귀

---

## 시각적 가독성

### 렌더링 레이어 순서 (아래에서 위로)

```
레이어 0: 바닥 타일 (흙, 돌, 잔디)
레이어 1: 바닥 이펙트 (마법진, 웅덩이, 그림자)
레이어 2: Corpse 드롭 (녹색 해골)
레이어 3: 장애물 하단부
레이어 4: 캐릭터 (적, 미니언, 네크로맨서) — Y축 정렬
레이어 5: 장애물 상단부 (캐릭터 뒤로 갈 수 있는 부분)
레이어 6: 투사체 & 이펙트
레이어 7: UI 오버레이 (데미지 숫자, 상태 아이콘)
```

### Y축 정렬 (Sprite Sort)

- 같은 레이어의 오브젝트는 Y축 값이 낮을수록(화면 아래) 앞에 렌더링
- Unity Sprite Renderer의 Sorting Order를 Y 위치 기반으로 동적 계산
- 계산 공식: `sortingOrder = -(int)(transform.position.y * 100)`

### 시각적 구분 컬러 가이드

| 대상 | 컬러 톤 | 목적 |
| --- | --- | --- |
| 네크로맨서 | 진한 보라 + 금색 포인트 | 화면 중심, 즉시 식별 |
| 아군 미니언 | 녹색/청록 외곽선 | 적과 명확히 구분 |
| 적 | 붉은/주황 톤 | 위협 인식 |
| Corpse | 녹색 발광 | 수집 유도 |
| 장애물 | 무채색 (회색/갈색) | 배경과 가까운 톤, 방해 최소화 |
| 특수 지형 | 강한 발광 (녹/보라) | 관심 유도 |
| 위험 장판 | 붉은/보라 발광 | 회피 유도 |

---

## 미니맵

### 기본 동작

| 항목 | 값 |
| --- | --- |
| 위치 | 화면 우상단 |
| 크기 | 120 × 120 px |
| 표시 범위 | 맵 전체 (80 × 80 유닛) |
| 투명도 | 70% (전투 방해 최소화) |

### 미니맵 아이콘

| 대상 | 아이콘 | 색상 |
| --- | --- | --- |
| 네크로맨서 | 큰 점 | 흰색 |
| 아군 미니언 | 작은 점 | 녹색 |
| 적 무리 | 영역 표시 | 붉은색 (개별 표시 아님, 밀집 영역만) |
| 보스 | 큰 해골 | 붉은색 |
| 특수 지형 | 아이콘 | 황색 |
| 뼈 제단 (활성) | 불꽃 아이콘 | 붉은색 |

---

## 성능 고려사항

| 항목 | 목표 | 대응 방안 |
| --- | --- | --- |
| 동시 활성 적 | 최대 150마리 | Object Pooling, 화면 밖 적 간소화 |
| 동시 미니언 | 최대 15마리 (슬롯 상한) | 슬롯 제한이 자연 제한 역할 |
| Corpse 오브젝트 | 최대 100개 | 5초 자동 소멸 + Object Pooling |
| 장애물 | 31~47개 (고정) | Static Collider, 런타임 생성/삭제 없음 |
| 바닥 타일 | 타일맵 사용 | Unity Tilemap 활용, 청크 로딩 불필요 (80×80은 충분히 작음) |
| 프레임 목표 | 60 FPS (최소 30 FPS) | 적 150 + 미니언 15 + Corpse 100 ≤ 총 엔티티 ~300 |

### 화면 밖 최적화

- 카메라 영역 밖 5 유닛 이상의 오브젝트는 **애니메이션 비활성화**
- 카메라 영역 밖 10 유닛 이상의 적은 **AI 업데이트 빈도 감소** (0.5초 → 1.0초)
- Corpse는 위치만 유지하고 파티클 비활성화

---

## 바이옴별 맵 레이아웃 예시

### 버려진 묘지 — 레이아웃 예시

```
    ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
    ░                                          ░
    ░     ▓▓    ~~~~~                          ░
    ░     ▓▓    ~~~~~        ▓                 ░
    ░           ~~~~~        ▓                 ░
    ░                                          ░
    ░  ▓                                 ▓▓   ░
    ░                 ◆◆                 ▓▓   ░
    ░      ▓▓▓▓       ◆◆                      ░
    ░      ▓▓▓▓                                ░
    ░                                          ░
    ░               ┌────┐                     ░
    ░     ~~~~~     │ 시작│         ▓           ░
    ░     ~~~~~     └────┘         ▓           ░
    ░     ~~~~~                                ░
    ░                    ▓▓                    ░
    ░         ▓          ▓▓        ▓▓▓▓▓▓▓▓   ░
    ░         ▓                    ▓▓▓▓▓▓▓▓   ░
    ░                      ◆◆                  ░
    ░              ~~~~~   ◆◆                  ░
    ░              ~~~~~                       ░
    ░                                          ░
    ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░

범례: ░ 죽음의 안개  ▓ 장애물  ~~~~~ 웅덩이  ◆◆ 네크로 원천
      ▓▓▓▓▓▓▓▓ 대형 장애물  시작 = 플레이어 시작 위치
```

---

## 향후 확장 고려

| 항목 | 설명 | 우선순위 |
| --- | --- | --- |
| 추가 바이옴 | 화산 지대, 얼어붙은 호수 등 | 낮음 (컨텐츠 확장기) |
| 동적 지형 변화 | 웨이브 10, 15에서 지형 붕괴/추가 | 중간 |
| 날씨 시스템 | 비, 안개 → 시야 제한, 이동속도 영향 | 낮음 |
| 비밀 방 | 특정 장애물 파괴 시 숨겨진 영역 등장 | 중간 |
| 이벤트 맵 | 시즌 이벤트용 특수 레이아웃 | 낮음 |
